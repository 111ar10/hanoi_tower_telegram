<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanoi Test</title>
    
    <!-- ‚úÖ Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #667eea;
            color: white;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            background: #48bb78;
            color: white;
            cursor: pointer;
            margin: 10px;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .info {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üóº Hanoi - Debug Mode</h1>
    
    <div class="info" id="info">
        <strong>Checking Telegram WebApp...</strong>
    </div>
    
    <div class="log" id="log">
        <strong>üìã Debug Log:</strong><br>
    </div>
    
    <button id="testBtn">üéÆ Test Send Data</button>
    <button id="closeBtn">‚ùå Close WebApp</button>
    
    <script>
        const logEl = document.getElementById('log');
        const infoEl = document.getElementById('info');
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            }[type] || '‚ÑπÔ∏è';
            
            console.log(`[${timestamp}] ${msg}`);
            logEl.innerHTML += `<br>${prefix} [${timestamp}] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Initialize
        log('üöÄ Script started');
        
        // Check Telegram WebApp
        if (!window.Telegram) {
            log('‚ùå window.Telegram NOT FOUND', 'error');
            infoEl.innerHTML = '<strong style="color: #f56565;">‚ùå Telegram SDK not loaded!</strong>';
        } else {
            log('‚úÖ window.Telegram found', 'success');
            
            const tg = window.Telegram.WebApp;
            
            if (!tg) {
                log('‚ùå Telegram.WebApp NOT FOUND', 'error');
                infoEl.innerHTML = '<strong style="color: #f56565;">‚ùå Telegram WebApp not available!</strong>';
            } else {
                log('‚úÖ Telegram WebApp found', 'success');
                
                // Initialize
                try {
                    tg.ready();
                    log('‚úÖ tg.ready() called', 'success');
                    
                    tg.expand();
                    log('‚úÖ tg.expand() called', 'success');
                    
                    tg.enableClosingConfirmation();
                    log('‚úÖ tg.enableClosingConfirmation() called', 'success');
                } catch (e) {
                    log(`‚ùå Init error: ${e.message}`, 'error');
                }
                
                // Get URL params
                const urlParams = new URLSearchParams(window.location.search);
                const sessionId = urlParams.get('sessionId');
                const userId = urlParams.get('userId');
                const difficulty = urlParams.get('difficulty');
                
                log(`üìç Session ID: ${sessionId || 'NOT FOUND'}`, sessionId ? 'success' : 'error');
                log(`üìç User ID: ${userId || 'NOT FOUND'}`, userId ? 'success' : 'error');
                log(`üìç Difficulty: ${difficulty || 'NOT FOUND'}`, difficulty ? 'success' : 'error');
                
                // Display info
                infoEl.innerHTML = `
                    <strong>‚úÖ Telegram WebApp Active</strong><br>
                    <small>
                    Version: ${tg.version || 'unknown'}<br>
                    Platform: ${tg.platform || 'unknown'}<br>
                    Session ID: ${sessionId || 'missing'}<br>
                    User ID: ${userId || 'missing'}
                    </small>
                `;
                
                // Test button
                document.getElementById('testBtn').addEventListener('click', () => {
                    log('üéØ Test button clicked', 'info');
                    
                    const testData = {
                        sessionId: sessionId || 'test-session-123',
                        gameId: 'hanoi',
                        userId: userId || 'test-user',
                        score: 85,
                        rating: 'A',
                        moves: 15,
                        timeElapsed: 45,
                        completed: true,
                        timestamp: Date.now()
                    };
                    
                    log('üì¶ Preparing data...', 'info');
                    log(`Data: ${JSON.stringify(testData)}`, 'info');
                    
                    const dataString = JSON.stringify(testData);
                    log(`üìè Data size: ${dataString.length} bytes`, 'info');
                    
                    try {
                        log('üì§ Calling tg.sendData()...', 'warning');
                        tg.sendData(dataString);
                        log('‚úÖ tg.sendData() called successfully!', 'success');
                        log('‚è≥ WebApp should close automatically...', 'info');
                        
                        // Fallback close after 2 seconds
                        setTimeout(() => {
                            log('üîÑ Calling tg.close()...', 'info');
                            tg.close();
                        }, 2000);
                        
                    } catch (e) {
                        log(`‚ùå sendData error: ${e.message}`, 'error');
                        log(`Stack: ${e.stack}`, 'error');
                    }
                });
                
                // Close button
                document.getElementById('closeBtn').addEventListener('click', () => {
                    log('üîÑ Closing WebApp...', 'info');
                    tg.close();
                });
                
                log('‚úÖ All event handlers attached', 'success');
                log('üëç Ready to test!', 'success');
            }
        }
    </script>
</body>
</html>
