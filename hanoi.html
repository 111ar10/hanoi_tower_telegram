<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hanoi Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #667eea;
            color: white;
            text-align: center;
        }
        button {
            padding: 20px 40px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            background: #48bb78;
            color: white;
            cursor: pointer;
            margin: 20px;
        }
        .info {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
        .log {
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üóº Hanoi Test</h1>
    
    <div class="info" id="info">Loading...</div>
    
    <button onclick="sendTestData()">üì§ Send Test Result</button>
    <button onclick="window.Telegram.WebApp.close()">‚ùå Close</button>
    
    <div class="log" id="log"></div>

    <script>
        const logEl = document.getElementById('log');
        const infoEl = document.getElementById('info');
        
        function log(msg) {
            console.log(msg);
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<br>[${timestamp}] ${msg}`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        log('üöÄ Starting...');
        
        // Check Telegram
        if (!window.Telegram?.WebApp) {
            infoEl.innerHTML = '‚ùå Telegram WebApp not found!';
            log('‚ùå No Telegram WebApp');
            throw new Error('No Telegram');
        }
        
        const tg = window.Telegram.WebApp;
        log('‚úÖ Telegram WebApp found');
        
        // Initialize
        tg.ready();
        tg.expand();
        log('‚úÖ Initialized');
        
        // Get URL params
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('sessionId');
        const userId = urlParams.get('userId');
        const difficulty = urlParams.get('difficulty');
        
        log(`Session: ${sessionId || 'MISSING'}`);
        log(`User: ${userId || 'MISSING'}`);
        log(`Difficulty: ${difficulty || 'MISSING'}`);
        
        // Display info
        infoEl.innerHTML = `
            <strong>‚úÖ Telegram WebApp Active</strong><br>
            Platform: ${tg.platform || 'unknown'}<br>
            Session: ${sessionId || 'missing'}<br>
            User: ${userId || 'missing'}<br>
            Difficulty: ${difficulty || 'missing'}
        `;
        
        function sendTestData() {
            log('üì§ Preparing test data...');
            
            const testResult = {
                sessionId: sessionId || 'test-session-123',
                gameId: 'hanoi',
                userId: userId || '123456',
                score: 850,
                rating: 'A',
                moves: 15,
                optimalMoves: 15,
                timeElapsed: 45,
                hintsUsed: 0,
                mistakes: 0,
                completed: true,
                difficulty: parseInt(difficulty) || 2,
                numDisks: 4,
                timestamp: Date.now()
            };
            
            log('üì¶ Test data:');
            log(JSON.stringify(testResult, null, 2));
            
            const dataString = JSON.stringify(testResult);
            log(`üìè Size: ${dataString.length} bytes`);
            
            if (dataString.length > 4096) {
                log('‚ö†Ô∏è WARNING: Data too large!');
                alert('Data too large! Max 4096 bytes');
                return;
            }
            
            try {
                log('üì§ Calling tg.sendData()...');
                tg.sendData(dataString);
                log('‚úÖ SENT! Check your bot...');
                
                alert('‚úÖ Data sent!\n\nCheck Node-RED debug panel.\n\nWebApp will close in 3 seconds...');
                
                setTimeout(() => {
                    log('üîÑ Closing WebApp...');
                    tg.close();
                }, 3000);
                
            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`);
                alert('Error: ' + error.message);
            }
        }
        
        log('‚úÖ Ready! Click "Send Test Result" button');
    </script>
</body>
</html>
